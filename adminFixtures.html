<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Include Material Design lite framework -->
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.2.1/material.indigo-pink.min.css">

    <script defer src="https://code.getmdl.io/1.2.1/material.min.js"></script>

    <title>Lughborough Table Tennis Cup</title>
    <link rel="stylesheet" type="text/css" href="CupPage.css">
    <link rel="stylesheet" type="text/css" href="NewCup.css">

</head>
<body>

<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header
            mdl-layout--fixed-tabs">
    <header class="mdl-layout__header">
        <div class="mdl-layout__header-row">
            <!-- Title -->
            <span class="mdl-layout-title">Admin Page</span>
        </div>
        <!-- Tabs -->
        <div class="mdl-layout__tab-bar mdl-js-ripple-effect">
            <a href="adminPanel.html" class="mdl-layout__tab">Main panel</a>
            <a href="adminFixtures.html" class="mdl-layout__tab is-active">All Fixtures</a>
            <a href="NewCup.html" class="mdl-layout__tab" >Group stage</a>
            <a href="CupPage.html" class="mdl-layout__tab">Playoffs</a>
            <a href="adminClubs.html" class="mdl-layout__tab">Clubs</a>
            <a href="adminTeams.html" class="mdl-layout__tab">Teams</a>
            <a href="adminPlayers.html" class="mdl-layout__tab">Players</a>

        </div>
    </header>
    <div class="mdl-layout__drawer">
        <span class="mdl-layout-title">Title</span>
    </div>                                                                                                   <!-- FIX ME -->
    <div class="mdl-layout__drawer">
        <span class="mdl-layout-title">Title</span>
        <nav class="mdl-navigation">
            <a class="mdl-navigation__link" href="">Cup Information</a>
            <a class="mdl-navigation__link" href="">Fixtures</a>
            <a class="mdl-navigation__link" href="">Teams</a>
            <a class="mdl-navigation__link" href="login.html">Login</a>
        </nav>
    </div>
    </header>

    <main class="mdl-layout__content" id="app">

        <div class="fixtures-card-wide mdl-card mdl-shadow--8dp">
            <div class="mdl-card__title">
                <h3 class="mdl-card__title-text">Fixtures</h3>
            </div>
            <div class="fixtures-table-container mdl-card__supporting-text">
                <table class="mdl-data-table mdl-js-data-table">
                    <thead>

                    <tr>
                        <th class="mdl-data-table__cell--non-numeric">#</th>
                        <th class="mdl-data-table__cell--non-numeric">Home</th>
                        <th class="mdl-data-table__cell--non-numeric">Away</th>
                        <th class="mdl-data-table__cell--non-numeric">Score</th>
                        <th class="mdl-data-table__cell--non-numeric">Date</th>
                    </tr>
                    </thead>
                    <tbody>
                        <template v-for="(item,index) in matches">
                            <tr style="cursor: pointer">
                                <td class="mdl-data-table__cell--non-numeric" v-on:click="directToMatchpage(item.id)">{{index+1}}</td>
                                <td class="mdl-data-table__cell--non-numeric" v-on:click="directToMatchpage(item.id)">{{item.homeTeam}}</td>
                                <td class="mdl-data-table__cell--non-numeric" v-on:click="directToMatchpage(item.id)">{{item.awayTeam}}</td>
                                <td class="mdl-data-table__cell--non-numeric" v-on:click="directToMatchpage(item.id)">{{item.scores}}</td>

                                <td class="mdl-data-table__cell--non-numeric" v-if="item.date === ''">
                                            <input  style="font-size: 13px; width: 90px; " type="text"  v-model.lazy="newDate" v-on:input="updateDate($event.target.value, item.id, index)" placeholder="YYYY-MM-DD">
                                </td>
                                <td class="mdl-data-table__cell--non-numeric" v-else v-on:click="directToMatchpage(item.id)">{{item.date}}</td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <!--<button v-on:click="getMatches">Fetch</button>-->
        </div>

    </main>

    <script src="https://unpkg.com/vue/dist/vue.js"></script>  <!-- include vue.js -->
    <script>
        var vueApp = new Vue({
            el: '#app',
            data: {
                newDate:"",
                matches:0

            },

            methods: {
                directToMatchpage: function(matchID){
                    localStorage.setItem("matchID",0); //used to clear it just in case something goes wrong
                    localStorage.setItem("matchID",matchID);    //The match id is added to local storage so it can be accessed later
                    //location.href('Matchpage.html');
                    window.location.replace('Matchpage.html');

                },

                updateDate: function(date,matchid, rowNumber){

                    if(date.length == 10){  //this is to make sure that the  date is only worked with when it is entered valid
                        //alert("hey: "+date+ "    "+matchid+ "     "+rowNumber);
                        this.matches[rowNumber].date = date;

                        var xhttp = new XMLHttpRequest();
                        xhttp.onreadystatechange = function() {                                                         //(callback function)this function runs after xhttp.open because we have asynchronous data sending so as soon as the data is recieved this is run
                            if (xhttp.readyState === XMLHttpRequest.DONE && xhttp.status == 200) {
                                console.log(this.responseText);
                                //I parse the rawdata received into jason structure then I pass it into and call the manipulate function
                                var data = vueApp.parseMatchesInfo(this.responseText);
                            }
                        };

                        xhttp.open("POST", "http://178.62.9.140:3080/updateMatchDate/matchID/"+matchid+"/newDate/"+date, true);
                        xhttp.send();
                    }

                },

                fetchMatches: function ( manipulate) {

                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {                                                         //(callback function)this function runs after xhttp.open because we have asynchronous data sending so as soon as the data is recieved this is run
                        if (xhttp.readyState === XMLHttpRequest.DONE && xhttp.status == 200) {
                            console.log(this.responseText);
                            //I parse the rawdata received into jason structure then I pass it into and call the manipulate function
                            var data = vueApp.parseMatchesInfo(this.responseText);

                            manipulate(data);
                        }
                    };

                    xhttp.open("GET", "http://178.62.9.140:3080/allMatches", true);
                    xhttp.send();

                },
                parseMatchesInfo: function (rawdata) {
                    //these two lines just parse the data so it can be accessed
                    var json = JSON.parse(rawdata);
                    return json;


                },

                getMatches: function () {
                    var global = this;
                    function manipulate(json) {
                        global.matches = json;

                        for (var i=0; i< global.matches.length;i++){        //this for loop is used to change the format of the date
                            global.matches[i].date = global.matches[i].date.substring(0,global.matches[i].date.search("T"));
                        }
                        if (global.matches[2].date){

                        }
                    }
                    this.fetchMatches(manipulate);
                }
            },
            mounted: function () {
                this.getMatches();

            }
        })
    </script>

</div>
</body>
</html>